name: get secret from secret manager
on:
  push
jobs:
  get-secret:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

  
    steps:
      
      - uses: actions/checkout@v4
      - id: 'auth' 
        name:  authenticate gke 
        uses: 'google-github-actions/auth@v2'
        with:
         
          workload_identity_provider: 'projects/499613830332/locations/global/workloadIdentityPools/deel/providers/github'
          service_account: 'github-actions-sa@deel-home-task-1.iam.gserviceaccount.com'
      - name: Install gke-gcloud-auth-plugin
        run: |
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
            sudo apt update
            sudo apt-get install google-cloud-sdk-gke-gcloud-auth-plugin kubectl
            export USE_GKE_GCLOUD_AUTH_PLUGIN=True
      - name: 'setup cloud sdk'
       
        run: |
            gcloud config set project ${{ secrets.GKE_PROJECT }}
            gcloud container clusters get-credentials "deel-cluster" --zone us-east5-a
      
      
      - name: Verify Kubernetes Context
        run: |
          kubectl config current-context || echo "Context not set!"
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - name: Deploy Helm Chart
        run: |
          ls -la
          helm upgrade --install my-release ./deel --namespace default --kube-context $(kubectl config current-context)
            #gcloud secrets versions access "latest" --secret "my_secret"
            #gcloud compute instances list
    